<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thông báo quá hạn</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/layout.css" />
  </head>

  <body>
    <div class="sidebar"></div>
    <div class="main">
      <div class="header"></div>

      <h5 style="margin-top: 8px">Thông báo quá hạn</h5>
      <h6 class="mt-3 mb-3">Danh sách quá hạn</h6>

      <div id="overdueList"></div>

      <div class="footer">© Thư viện UCC</div>
    </div>

    <!-- MODAL -->
    <div class="modal fade" id="overdueModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Gửi thông báo quá hạn</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <p><b>Độc giả:</b> <span id="od-reader"></span></p>
            <p><b>Sách:</b> <span id="od-book"></span></p>
            <p><b>Ngày đến hạn:</b> <span id="od-han"></span></p>
            <p>
              <b>Số ngày quá hạn:</b>
              <span id="od-days" style="color: red; font-weight: bold"></span>
            </p>
          </div>

          <div class="modal-footer">
            <button id="sendNoticeBtn" class="btn btn-primary">
              Gửi thông báo
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- END MODAL -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="data.js"></script>
    <script src="assets/js/common.js"></script>

    <script>
      // Load dữ liệu
      initializeLibraryData();
      const d = getLibraryData();

      renderSidebar("overdue");
      renderHeader("Thông báo quá hạn");

      const muon = d.muonTra;
      const sach = d.sach;
      const docGia = d.docGia;

      console.log("DỮ LIỆU MƯỢN TRẢ:", muon);

      // Helpers -------------------
      function bookOf(id) {
        return sach.find((b) => b.id === id) || { tieuDe: "Không rõ" };
      }

      function readerOf(id) {
        return docGia.find((r) => r.id === id) || { hoTen: "Không rõ" };
      }

      function formatDate(d) {
        const dt = new Date(d);
        return dt.toLocaleDateString("vi-VN");
      }

      // OPEN MODAL -----------------
      function openModal(item) {
        const book = bookOf(item.sachId);
        const reader = readerOf(item.docGiaId);

        const daysLate = Math.floor(
          (new Date() - new Date(item.hanTra)) / 86400000
        );

        document.getElementById("od-reader").innerText = reader.hoTen;
        document.getElementById("od-book").innerText = book.tieuDe;
        document.getElementById("od-han").innerText = formatDate(item.hanTra);
        document.getElementById("od-days").innerText = daysLate;

        const modal = new bootstrap.Modal(
          document.getElementById("overdueModal")
        );
        modal.show();

        document.getElementById("sendNoticeBtn").onclick = () => {
          // soạn email
          const subject = encodeURIComponent(
            "Thông báo quá hạn sách từ thư viện UCC"
          );
          const body = encodeURIComponent(
            `Xin chào ${reader.hoTen},

        Bạn đang có một cuốn sách đã quá hạn:

    • Tên sách: ${book.tieuDe}
    • Ngày đến hạn: ${formatDate(item.hanTra)}
    • Số ngày quá hạn: ${daysLate} ngày

Vui lòng đến thư viện để trả sách trong thời gian sớm nhất.

Trân trọng,
Thư viện HAUI`
          );

          // mở gmail
          window.location.href = `https://mail.google.com/mail/?view=cm&fs=1&to=${reader.email}&su=${subject}&body=${body}`;
        };
      }

      // RENDER LIST ----------------
      function renderOverdue() {
        const list = document.getElementById("overdueList");
        list.innerHTML = "";

        const overdueItems = muon.filter(
          (m) => m.trangThai === "Đang mượn" && new Date(m.hanTra) < new Date()
        );

        console.log("OVERDUE ITEMS:", overdueItems);

        if (overdueItems.length === 0) {
          list.innerHTML = `<p style="color:gray;">Không có sách quá hạn.</p>`;
          return;
        }

        overdueItems.forEach((item, idx) => {
          const book = bookOf(item.sachId);
          const reader = readerOf(item.docGiaId);
          const daysLate = Math.floor(
            (new Date() - new Date(item.hanTra)) / 86400000
          );

          list.insertAdjacentHTML(
            "beforeend",
            `
          <div class="tx-card">
            <div class="tx-row">
              <div class="tx-left">
                <div class="book-title">${book.tieuDe}</div>
                <div class="book-sub">${reader.hoTen}</div>
              </div>

              <button 
                class="btn-overdue"
                style="
                  background:#ffd6d6;
                  border:none;
                  padding:6px 14px;
                  border-radius:20px;
                  cursor:pointer;
                ">
                Quá hạn (+${daysLate} ngày)
              </button>
            </div>
          </div>
        `
          );
        });

        // Attach click
        document.querySelectorAll(".btn-overdue").forEach((btn, index) => {
          btn.addEventListener("click", () => openModal(overdueItems[index]));
        });
      }

      renderOverdue();
    </script>
  </body>
</html>
